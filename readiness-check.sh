#!/bin/bash

# Kafka 
kafka_broker="${KAFKA_BROKERS}"
if ! kafka-topics.sh --bootstrap-server "${kafka_broker}" --list &> /dev/null; then
  echo "Kafka is not reachable"
  exit 1
fi
echo "Kafka is reachable"

# Kafka topic
kafka_topic="${KAFKA_TOPIC}"
if ! kafka-topics.sh --bootstrap-server "${kafka_broker}" --list | grep -q "${kafka_topic}"; then
  echo "Kafka topic ${kafka_topic} does not exist"
  exit 1
fi
echo "Kafka topic ${kafka_topic} exists"

# Postgres connection check
postgres_host="${DB_HOST}"
postgres_port="${DB_PORT}"
postgres_user="${DB_USER}"
postgres_password="${DB_PASSWORD}"
postgres_database="${DB_NAME}"

PGPASSWORD="${postgres_password}" pg_isready -h "${postgres_host}" -p "${postgres_port}" -U "${postgres_user}" -d "${postgres_database}"
if [ $? -ne 0 ]; then
  echo "PostgreSQL is not ready"
  exit 1
fi
echo "PostgreSQL is ready"

# All checks
exit 0
